<html>
  <head>
    <title> Panjiva Coding Lesson </title>
    <script src='lisp.js' type='text/javascript'></script>
    <script src='jquery-1.7.1.js' type='text/javascript'></script>
    <script src='processing-1.3.6.js' type='text/javascript'></script>

    <script type='text/javascript'>
      $(function() {
        $('#eval').click(function(evt) {
          running = typeof(running) == 'undefined' ? true : !running;
          $('#eval').html(running ? 'Stop!' : 'Run!');
          evt.preventDefault();
        });
      });

      prelude = " ";
      epilogue = " ";

    </script>


  </head>
  <body>

    <div class='px640x300'>

      <!-- game -->
      <script type='application/processing'>
        // @pjs preload must be used to preload the image so that it will be available when used in the sketch  
        /* @pjs preload="map.png"; */

        PImage a;

        speed = 2;

        x = 50;
        y = 50;


        void setup() {
          size(640, 300);
          smooth();
          a = loadImage("map.png");
        }

        void draw() {
          background(226);
          image( a, 0, 0 );

          if(!(typeof(running) == 'undefined') && running) {

            output = interpret($('#program').val());

            $('#output').val(output);

            if(typeof(direction) == 'undefined') {
              direction = 0;
            }

            console.log(direction);


            if(direction == 0) {
              target_x = x;
              target_y = y - speed;
            } else if(direction == 1) {
              target_x = x + speed;
              target_y = y;
            } else if(direction == 2) {
              target_x = x;
              target_y = y + speed;
            } else if(direction == 3) {
              target_x = x - speed;
              target_y = y;
            }

            console.log([x, y, target_x, target_y, speed, direction]);

            ellipse(target_x, target_y, 10, 10);
            x = target_x;
            y = target_y;
            /*
            dragSegment(0, target_x - 8, target_y - 8);
            for(int i=0; i < _x.length-1; i++) {
              dragSegment(i+1, _x[i], _y[i]);
            }
            */
          }

        }

        void dragSegment(int i, float xin, float yin) {
          float dx = xin - _x[i];
          float dy = yin - _y[i];
          float angle = atan2(dy, dx);  
          console.log(angle);
          _x[i] = xin - cos(angle) * segLength;
          _y[i] = yin - sin(angle) * segLength;
          //stroke(23, 79, 4, 220);
          
          pushMatrix();
          translate(_x[i], _y[i]);
          rotate(angle);
          
          color c;
          
          if ( i % 3 == 1 )
            c = color(0, 0, 0, 255);
          else if ( i % 3 == 2 )
            c = color(255, 255, 0, 255);
          else
            c = color(255, 0, 0, 255);

          stroke( c );
          strokeWeight(10);
          line(0, 0, segLength, 0);
          
          if ( i == _x.length - 1 )
          {
            fill( c );
            noStroke();
            beginShape(TRIANGLES);
            vertex(0, 5);
            vertex(-2 * segLength, 0);
            vertex(0, -5);
            endShape();
          }
          
          if ( i == 0 )
          {
           // stroke(0, 255);
           noStroke();
           fill(0, 255);
           ellipse(segLength, -2, 3, 3);
           ellipse(segLength, 2, 3, 3);
            //point(segLength, -2);
            //point(segLength, 2);
          }
          
          popMatrix();
        }
      </script>
      <canvas width="640" height="300"></canvas>
    </div>
      <textarea rows=20 cols=60 id='program'> </textarea>
      <br />
      <a href='#' id='eval'>Run!</a>
      <textarea rows=5 id='output'> </textarea>
      <div style='display:none'><img src="map.png" id="map.png"/></div>
    </div>

  </body>

</html>
